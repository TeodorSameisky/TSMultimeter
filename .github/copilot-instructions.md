# TSMultimeter Copilot Guide
- **System layout**: `backend/src/main.rs` runs a Warp HTTP server on `127.0.0.1:8080`; `frontend/src/App.tsx` is a Vite-powered React UI that can also be bundled via Electron (`frontend/electron-main.ts`).
- **Shared state**: `backend/src/communication.rs` owns `AppState` (`Arc<Mutex<...>>`) keyed by generated `device_####` strings; clone the filters when wiring new routes so every handler shares the same registry.
- **REST contract**: Core routes are `POST /connect`, `POST /disconnect/{device_id}`, `GET /measurement/{device_id}`, `GET /status`, `GET /ports`. Payloads must match the shapes normalised in `frontend/src/hooks/useDevice.ts`.
- **Device onboarding**: Extend `connect_device` and `DeviceType` in `backend/src/communication/mod.rs` + `backend/src/device/mod.rs`, plumb creation logic into `create_device`, and surface the new string through `DEVICE_TYPE_OPTIONS` and mock handling in `frontend/src/hooks/useDevice.ts`.
- **Serial drivers**: `backend/src/device/fluke.rs` wraps `serialport::new` with `.timeout(...)`, emits CR-terminated commands, and expects `ACK`-prefixed frames; reuse the existing helper functions to preserve framing.
- **Mock pipeline**: `backend/src/device/mock.rs` produces varied readings that exercise polling without hardware; prefer this driver for tests and developer mode flows.
- **Measurement schema**: Unit/state/attribute enums live in `backend/src/device/mod.rs`. Any new variant requires updates to `UNIT_DISPLAY_MAP` in `frontend/src/hooks/useDevice.ts`, number formatting in `frontend/src/utils/formatNumber.ts`, and math-channel validation paths.
- **Error handling**: Backend handlers return `Result<T, String>` so `backend/src/main.rs` can respond with `{ success: false, error }`. Introduce richer errors in `backend/src/error.rs` if the caller needs more context.
- **Tracing**: `backend/src/lib.rs::init` wires `tracing_subscriber`; prefer `tracing::info!` / `tracing::warn!` over `println!` so log filtering keeps working.
- **Frontend polling**: `frontend/src/hooks/useDevice.ts` polls each connected device every 500 ms, caps history at 5000 samples, and resets history when the unit string changes; reuse `getMeasurement` rather than manual fetch loops.
- **Measurement history**: `frontend/src/components/MeasurementHistory` is driven by `useMeasurementHistoryController.ts`, which groups cursor, zoom, axis, and pointer controls from dedicated hooks. Extend functionality by threading data through `useMeasurementDerivedState` and keeping control objects memoised.
- **Math channels**: `frontend/src/hooks/useMathChannelHistory.ts` recomputes derived series on history updates. Whitelist new identifiers in `frontend/src/utils/mathExpressions.ts` before exposing them.
- **Channel settings**: `frontend/src/state/channelSettingsReducer.ts` and `useChannelSettingsManager.ts` own alias/color/unit mutations. Dispatch reducer actions; never mutate arrays directly.
- **Developer mode**: `frontend/src/hooks/useDeveloperMode.ts` gates the Mock device and experimental UI. Respect this flag when adding hidden features.
- **ID generation**: Backend assigns sequential device IDs; the frontend creates stable IDs via `frontend/src/utils/createId.ts` for math channels and overlays.
- **Styling pattern**: Components co-locate styled-components alongside logic (see `frontend/src/components/AppLayout`). Prefer extending the exported styled primitives instead of adding global CSS.
- **Backend workflows**: `cd backend; cargo run` during development, `cargo build --release` for packaging, and `frontend/scripts/build-backend.js` (triggered by `npm run package:standalone`) to bundle Rust for Electron.
- **Frontend workflows**: `cd frontend; npm install` once, then `npm run dev` for browser hot reload, `npm run electron:dev` or `npm run electron` for desktop shell. Use `npm run lint`, `npm run type-check`, and `npm run test -- --run` (Vitest with jsdom/globals) before committing.
- **Packaging**: `npm run package:standalone` builds the backend, compiles the React app, then runs electron-builder; artifacts land under `frontend/release/`.
- **Port discovery**: `backend/src/communication/mod.rs::get_available_ports` wraps `serialport::available_ports`. When running on CI or without devices, stub or mock this call.
- **API smoke tests**: The root `README.md` includes curl snippets for `/status`, `/connect`, `/measurement`, `/disconnect`. Keep responses backward compatible with those examples.
- **Documentation sources**: Place protocol specifics under `protocols/` and surface high-level behaviour in `README.md`; update both when adding devices so the frontend/backends stay in sync.
